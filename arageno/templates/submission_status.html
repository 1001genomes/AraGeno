{% extends "base.html" %}
{% load humanize %}
{% load staticfiles %}
{% load filename %}
{% block content %}
<link rel="stylesheet" href="//unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
<script src="//unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
<script type="text/javascript" src="{% static 'js/leaflet-providers.js' %}"></script>

<script type="text/x-template" id="crosses-result-template">
    <div class="identify-info mdl-card" >
        <div class="mdl-card__title">
            <h2 class="mdl-card__title-text">Crosses-Check</h2>
        </div>
        <div class="mdl-card__supporting-text">
            <job-status
                    :status="job.status"
                    :progress="job.progress"
                    :remaining="job.remaining"
                    :statusText="job.statusText"
                    :interpretation="interpretation"
                    :id="job.id"
            ></job-status>
        </div>
        <div class="mdl-card__chart">
            <div class="mdl-grid">
                <div class="mdl-cell mdl-cell--12-col">
                    <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
                        <div class="mdl-tabs__tab-bar">
                            <a href="#stats-panel" class="mdl-tabs__tab is-active">Stats</a>
                            <a href="#table-panel" class="mdl-tabs__tab">Table</a>
                            <a href="#map-panel" class="mdl-tabs__tab" ref="maptab">Map</a>
                            <a v-show="hasWindows" href="#plot-panel" class="mdl-tabs__tab">Windows</a>
                        </div>
                        <div class="mdl-tabs__panel is-active" id="stats-panel">

                            <vue-chart
                                chart-type="ColumnChart"
                                :columns="crossesChartColumns"
                                :rows="crossesChartRows"
                                :options="crossesChartOptions"
                            ></vue-chart>
                        </div>
                        <div class="mdl-tabs__panel" id="table-panel">
                            <div style="height:350px;overflow-x:auto">
                                <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp" style="width:100%;margin-top:10px;">
                                    <thead>is-active
                                        <tr>
                                            <th class="mdl-data-table__cell--non-numeric">ID</th>
                                            <th class="mdl-data-table__cell--non-numeric">Rel.</th>
                                            <th class="mdl-data-table__cell--non-numeric">Name</th>
                                            <th ># Windows</th>
                                            <th class="mdl-data-table__cell--non-numeric">Country</th>
                                            <th class="mdl-data-table__cell--non-numeric">Picture</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="row in tableData"  class="crosses_table__row" v-bind:class="{ 'crosses_table__row--parent': row.relation }">
                                            <td class="mdl-data-table__cell--non-numeric"><a v-bind:href="row.url" target="_blank">{{ "{{ row.id }" }}}</a></td>
                                            <td class="mdl-data-table__cell--non-numeric">{{ "{{ row.relation }" }}}</td>
                                            <td class="mdl-data-table__cell--non-numeric">{{ "{{ row.name }" }}}</td>
                                            <td >{{ "{{ row.windows }" }}}</td>
                                            <td class="mdl-data-table__cell--non-numeric">{{ "{{ row.country }" }}}</td>
                                            <td class="mdl-data-table__cell--non-numeric"><img style="width:50px;height:50px" alt="No Picture available" v-bind:src="row.pictureUrl"></img></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="mdl-tabs__panel" id="map-panel">
                            <div class="map-chart" ref="map_container"></div>
                        </div>
                        <div class="mdl-tabs__panel" id="plot-panel">
                            <img v-if="hasWindows" class="window-plot" v-bind:src="job.plotUrl">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>
<script type="text/x-template" id="job-status-template">
    <div class="mdl-grid">
        <div class="mdl-cell mdl-cell--2-col">
            Status:
        </div>
            <div class="mdl-cell mdl-cell--10-col" >
                <div class="valign-center job-status" v-bind:class="statusCssClass">
                    <i class="material-icons">{{ "{{ statusIcon }" }}}</i> <span>{{ "{{ statusText }" }}}</span>
                </div>
        </div>
        <div class="mdl-cell mdl-cell--2-col">
            Progress ( {{ "{{ progressText }" }}}):
        </div>
        <div class="mdl-cell mdl-cell--10-col">
            <div v-bind:id="'status_progress_' + id" class="progress mdl-progress mdl-js-progress"></div>
        </div>
        <div class="mdl-cell mdl-cell--2-col">
            <div class="valign-center" style="line-height:24px">
                Interpretation:
            </div>
        </div>
        <div class="mdl-cell mdl-cell--10-col" >
            <div class="valign-center interpretation" v-bind:class="interpretationCssClass">
                <i class="material-icons">{{ "{{ interpretationIcon }" }}}</i> <span>{{ "{{ interpretationText }" }}}</span>
            </div>
        </div>
    </div>
</script>


<script type="text/x-template" id="identify-result-template">
    <div class="identify-info mdl-card mdl-shadow--3dp" >
        <div class="mdl-card__title">
            <h2 class="mdl-card__title-text">Identify results ({{ "{{ job.dataset.name }" }}})</h2>
        </div>
        <div class="mdl-card__supporting-text">
            <job-status
                    :status="job.status"
                    :progress="job.progress"
                    :remaining="job.remaining"
                    :statusText="job.statusText"
                    :interpretation="interpretation"
                    :id="job.id"
            ></job-status>
        </div>
        <div class="mdl-card__chart">
            <div class="mdl-grid">
                <div class="mdl-cell mdl-cell--4-col" style="margin:auto;position:relative;">
                    <div v-if="finished" class="mdl-typography--body-2 mdl-typography--text-center">Overlap: {{ "{{ overlapAbs }" }}} markers</div>
                    <span ref="overlapLabel" class="overlap-label">{{ "{{ overlap }" }}}</span>
                    <vue-chart
                        chart-type="PieChart"
                        :columns="overlapChartColumn"
                        :rows="overlapChartRows"
                        :options="overlapChartOptions"
                        ref="pieChart"
                    ></vue-chart>
                </div>
                <div class="mdl-cell mdl-cell--8-col">
                    <div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
                        <div class="mdl-tabs__tab-bar">
                            <a href="#stats-panel" class="mdl-tabs__tab is-active">Stats</a>
                            <a href="#table-panel" class="mdl-tabs__tab">Table</a>
                            <a href="#map-panel" class="mdl-tabs__tab" ref="maptab">Map</a>
                        </div>
                        <div class="mdl-tabs__panel is-active" id="stats-panel">
                            <vue-chart class="histogram-chart" v-if="showHistogram"
                                chart-type="Histogram"
                                :columns="identifyHistogramColumns"
                                :rows="identifyHistogramRows"
                                :options="identifyHistogramOptions" key="histogram-chart"
                            ></vue-chart>
                           <vue-chart class="column-chart" v-else
                                chart-type="ColumnChart"
                                :columns="identifyColumnChartColumns"
                                :rows="identifyColumnChartRows"
                                :options="identifyColumnChartOptions" key="column-chart"
                            ></vue-chart>
                        </div>
                        <div class="mdl-tabs__panel" id="table-panel">
                            <div style="height:350px;overflow-x:auto">
                                <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp" style="width:100%;margin-top:10px;">
                                    <thead>
                                        <tr>
                                            <th class="mdl-data-table__cell--non-numeric">ID</th>
                                            <th class="mdl-data-table__cell--non-numeric">Name</th>
                                            <th >Prob. (%)</th>
                                            <th >Overlap (%)</th>
                                            <th class="mdl-data-table__cell--non-numeric">Country</th>
                                            <th class="mdl-data-table__cell--non-numeric">Picture</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="row in tableData">
                                            <td class="mdl-data-table__cell--non-numeric"><a v-bind:href="row.url" target="_blank">{{ "{{ row.id }" }}}</a></td>
                                            <td class="mdl-data-table__cell--non-numeric">{{ "{{ row.name }" }}}</td>
                                            <td >{{ "{{ roundForDisplay(row.probability) }" }}} %</td>
                                            <td >{{ "{{ roundForDisplay(row.overlap) }" }}} %</td>
                                            <td class="mdl-data-table__cell--non-numeric">{{ "{{ row.country }" }}}</td>
                                            <td class="mdl-data-table__cell--non-numeric"><img style="width:50px;height:50px" alt="No Picture available" v-bind:src="row.pictureUrl"></img></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="mdl-tabs__panel" id="map-panel">
                            <div class="map-chart" ref="map_container"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mdl-grid" v-if="isCrossesCheck">
                <crosses-result
                    :job="job.crossesjob"
                    :accessions = "accessions"
                ></crosses-result>

            </div>
        </div>
        <div class="mdl-card__actions mdl-card--border">
            <a v-if="finished" href="" style="float:right" class="mdl-button mdl-js-button  mdl-button--accent mdl-button--raised">
                <i class="material-icons">file_download</i> Download
            </a>
            <button v-else disabled style="float:right" class="mdl-button mdl-js-button  mdl-button--accent mdl-button--raised"><i class="material-icons">file_download</i> Download</button>
        </div>
    </div>
</script>
<section class="site-section">
    <div class="resp-content" id="app">
        <h1 class="mdl-typography--display-2 mdl-typography--font-thin mdl-typography--text-center">
            Status of identification
        </h1>
        <div class="mdl-grid">
            <p class="mdl-cell mdl-cell--12-col mdl-typography--headline">
                Hello {{ "{{ fullname }" }}}!<br>
                <span v-if="finished">Your submission is finished.</span>
                <span v-else>Your submission is currently being processed.</span>
            </p>
            <div class="mdl-cell mdl-cell--12-col">
                <div class="genotype-info mdl-card mdl-shadow--3dp">
                    <div class="mdl-card__title">
                        <h2 class="mdl-card__title-text">Genotype statistics</h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        <div class="mdl-grid">
                            <div class="mdl-cell mdl-cell--2-col">
                                Genotype:
                            </div>
                            <div class="mdl-cell mdl-cell--10-col">
                                <a href="/uploads/{{ object.genotype_file.name }}" target="blank">{{ object.genotype_file | filename }}</a>
                            </div>
                            <div class="mdl-cell mdl-cell--2-col">
                                Submitted:
                            </div>
                            <div class="mdl-cell mdl-cell--10-col">
                                {{ object.submission_date | naturaltime }}
                            </div>
                             <div class="mdl-cell mdl-cell--2-col">
                                Status:
                            </div>
                             <div class="mdl-cell mdl-cell--10-col" id="parse-status">
                                {{ "{{ statusText }" }}}
                            </div>
                           <div class="mdl-cell mdl-cell--2-col">
                                Progress ( {{ "{{ progress }" }}} %):
                            </div>
                            <div class="mdl-cell mdl-cell--10-col">
                                <div id="genotype_progress" class="progress mdl-progress mdl-js-progress"></div>
                            </div>
                            <div class="mdl-cell mdl-cell--2-col" class="valign-center" style="line-height:24px;">
                                # Markers:
                            </div>
                             <div class="mdl-cell mdl-cell--10-col" >
                                 <div class="valign-center">
                                    <span style="margin-right:20px">{{ "{{ numberOfSNPs }" }}}</span>
                                    <span class="valign-center interpretation" v-bind:class="hasIssues ? 'interpretation--error' : 'interpretation--ok'" v-show="parseFinished">
                                        <i class="material-icons">{{ "{{ interpretationIcon }" }}}</i>
                                        <span>{{ "{{ interpretation }" }}}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mdl-card__chart">
                        <vue-chart
                            chart-type="ColumnChart"
                            :columns='[{"type":"string","label":"Chromosome"},{"type":"number","label":"Number of Markers"}]'
                            :rows="genotypeChartRows"
                            :options="genotypeChartOptions"
                        ></vue-chart>
                    </div>
                    <div class="mdl-card__actions mdl-card--border" >
                         <a href="{% url 'delete_submission' object.id %}" style="float:right" class="mdl-button mdl-js-button  mdl-button--delete mdl-button--raised">
                            <i class="material-icons">delete</i> Delete
                        </a>
                    </div>
                </div>
            </div>
            <div class="mdl-cell mdl-cell--12-col">
                <identify-result :job="job" :accessions="accessions" v-for="job in identifyjobSet" ></identify-result>
            </div>
        </div>
    </div>
</section>
<script>

    if (!Array.prototype.findIndex) {
        Object.defineProperty(Array.prototype, 'findIndex', {
            value: function(predicate) {
            'use strict';
            if (this == null) {
                throw new TypeError('Array.prototype.findIndex called on null or undefined');
            }
            if (typeof predicate !== 'function') {
                throw new TypeError('predicate must be a function');
            }
            var list = Object(this);
            var length = list.length >>> 0;
            var thisArg = arguments[1];
            var value;

            for (var i = 0; i < length; i++) {
                value = list[i];
                if (predicate.call(thisArg, value, i, list)) {
                return i;
                }
            }
            return -1;
            },
            enumerable: false,
            configurable: false,
            writable: false
        });
    }


   var popupOptions ={
        'maxWidth': '500',
        'className' : 'map-popup'
   }
   var LeafIcon = L.Icon.extend({
    options: {
            shadowUrl:  "{% static 'img/leaf-shadow.png' %}",
            iconSize:     [38, 95],
            shadowSize:   [50, 64],
            iconAnchor:   [22, 94],
            shadowAnchor: [4, 62],
            popupAnchor:  [-3, -76]
        }
    });


    var greenIcon = new LeafIcon({iconUrl: "{% static 'img/leaf-green.png' %}"}),
    redIcon = new LeafIcon({iconUrl: "{% static 'img/leaf-red.png' %}"}),
    orangeIcon = new LeafIcon({iconUrl: "{% static 'img/leaf-orange.png' %}"});


   {% autoescape off %}

    var defaultGenotypeChartRows = {
        'Chr1': 400,
        'Chr2': 700,
        'Chr3': 200,
        'Chr4': 350,
        'Chr5': 600
    };
    var defualtOverlapChartRows = [
        ['match',10],
        ['nomatch',10]
    ];
    var defaultIdentifyChartRows = [
        ['Acc1', 0.8,1000,0.9],
        ['Acc2', 0.6,4000,0.2],
        ['Acc3',0.4,2000,0.9],
        ['Acc4', 0.3,1000,0.4],
        ['Acc5', 0.2,5000,0.2]
    ];


    function setProgress(id,progress) {
        var elem = document.querySelector(id);
        if (elem.MaterialProgress !== undefined) {
            elem.MaterialProgress.setProgress(progress);
        }
        else {
            elem.addEventListener('mdl-componentupgraded', function() {
                this.MaterialProgress.setProgress(progress);
            });
        }
    }


    Vue.use(VueCharts);

   Vue.component('job-status', {
        template: '#job-status-template',
        props: ['status','statusText','progress','interpretation','id'],


        mounted: function () {
            this.$nextTick(function () {
                componentHandler.upgradeDom();
                setProgress('#status_progress_'+ this.id,this.progress);
            })
        },
        watch: {
            progress :function(progress) {
                setProgress('#status_progress_' + this.id,progress);
            }
        },
        computed:  {
            progressText: function() {
                var txt = this.progress + ' %';
                if (!this.finished && this.remaining) {
                    txt = txt+ ' / ' + this.remaining+ ' secs';
                }
                return txt;
            },
            statusCssClass: function() {
                if (this.statusText) {
                    return "job-status--" + this.statusText.toLowerCase();
                }
                return "";
            },
            statusIcon: function() {
                if (this.status === -1) {
                    return "error_outline";
                }
                else if (this.status === 0) {
                    return ""
                }
                else if (this.status === 1) {
                    return ""
                }
                else if (this.status === 2) {
                    return "loop";
                }
                else {
                    return "done";
                }
            },
            interpretationCssClass: function() {
                if (!this.finished) {
                    return 'interpretation--processing';
                }
                return this.hasIssues ? 'interpretation--error' : 'interpretation--ok'
            },
            interpretationIcon: function() {
                if (!this.finished) {
                    return 'loop';
                }
                if (!this.hasIssues) {
                    return 'check_circle';
                }
                return 'warning';
            },
            hasIssues: function() {
               return this.interpretationCase !== 0;
            },
            interpretationCase: function() {
                if (this.finished && this.interpretation) {
                    return this.interpretation.case;
                }
                return null;
            },
            interpretationText: function() {
                if (this.finished && this.interpretation) {
                    return this.interpretation.text;
                }
                else if (this.status === -1) {
                    return "There are issues";
                }
                return 'Processing...';
            },
            finished: function() {
                return this.status == 3 || this.status == -1;
            },
        }
   });

   Vue.component('crosses-result', {
        template: '#crosses-result-template',
        props: ['job','accessions'],

        data: function() {
            return {
                map: false,
                markers: new L.featureGroup(),
            }
        },
        mounted: function () {
            this.$nextTick(function () {
                componentHandler.upgradeDom();
                this.map = L.map(this.$refs.map_container).setView([0.0, 0.0], 2);
                L.tileLayer.provider('Stamen.TonerLite').addTo(this.map);
                this.initMarkers(this.job);
                 this.$refs.maptab.addEventListener("click", function() {
                    this.map.invalidateSize(false);
                }.bind(this));
            })

        },
        watch: {
            job: {
                handler: function(job) {
                    this.initMarkers(job);
                },
                deep:true
            },

        },
        methods: {
            initMarkers: function(job) {
                var accessions =  this.tableData.slice(0,10);
                if (this.job.statistics ) {
                    accessions = [];
                    this._addParent(accessions,'father');
                    this._addParent(accessions,'mother');
                }
                accessions.forEach(function(acc) {
                    if (acc.latitude === null || acc.longitude === null)
                        return;
                    var icon = this.getIconFromWindow(acc.windows);
                    var popupText = acc.name+' ('+acc.id+'): '+acc.windows;
                    if (acc.relation) {
                        popupText = popupText+", Rel: " + acc.relation;
                    }
                    var popup = popupText+"<br><img style='width:100px;height:100px' src='"+acc.pictureUrl+"' alt='No picture available' />";
                    this.markers.addLayer(L.marker([acc.latitude, acc.longitude], {icon: icon}).bindPopup(popup,popupOptions));
                }.bind(this));
                this.markers.addTo(this.map);
                try {
                    this.map.setView(this.markers.getBounds().getCenter());
                }
                catch (e) {

                }
            },
            getIconFromWindow(windows) {
                if (windows > 0) {
                    return greenIcon;
                }
                else if (windows > 5) {
                    return orangeIcon;
                }
                else {
                    return redIcon;
                }
            },
            roundForDisplay: function(value) {
                return Math.round(value*1000)/10;
            },

            _findAccIdx(rows,acc_id,forChart) {
                return rows.findIndex(function(obj) {
                    if (forChart) {
                        return obj[0] === acc_id;
                    }
                    else {
                        return obj.id === acc_id;
                    }
                }.bind(this));
            },
            _addParent: function(rows,parent,forChart) {
                if (!this.job.statistics.parents[parent]) {
                    return;
                }
                var parentId = this.job.statistics.parents[parent][0];
                var parentText = parent.toUpperCase() + ' ('+this.job.statistics.parents[parent][1]+')';
                var parentIdx = this._findAccIdx(rows,parentId,forChart);
                if (parentIdx === -1) {
                    var newObj = this.job.statistics.matches[this._findAccIdx(this.job.statistics.matches,parentId,true)];
                    if (forChart) {
                        rows.push([newObj[0],newObj[1],parentText,'']);
                    }
                    else {
                        newObj = this._getAccFromObj(newObj);
                        newObj.relation = parentText;
                        rows.push(newObj);
                    }
                }
                else {
                    if (forChart) {
                        rows[parentIdx][2] = parentText;
                        rows[parentIdx][3] = '';
                    }
                    else {
                        rows[parentIdx].relation = parentText;
                    }
                }
            },
            _getAccFromObj: function(obj) {
                acc = this.accessions[obj[0]];
                if (acc === undefined || acc === null) {
                    return {'id':obj[0],'windows':obj[1]}
                }
                return {'id':obj[0],'windows':obj[1]
                        ,'name':acc.name,'country':acc.country,'sitename':acc.sitename
                        ,'latitude':acc.latitude,'longitude':acc.longitude,
                        'pictureUrl':acc.pictureUrl, 'url':acc.url, 'relation':null};
            }

        },
        computed: {
            interpretation: function() {
                if (this.finished) {
                    return this.job.statistics.interpretation;
                }
                return null;
            },
            hasWindows: function() {
                if (this.finished) {
                    return this.interpretation.case == 6;
                }
                return false;
            },
            totalNumberMatches: function() {
                if (this.finished) {
                    return this.job.statistics.matches.length;
                }
                return '';
            },
            title: function() {
                var ret = 'Crosses result';
                var postfix = ' (Processing...)';
                if (this.finished) {
                    if (this.totalNumberMatches > 10) {
                        postfix = ' (Top 10 of ' + this.totalNumberMatches + ' matches)';
                    }
                    else if( this.totalNumberMatches > 1) {
                        postfix = ' (' + this.totalNumberMatches + ' matches)';
                    }
                    else if (this.totalNumberMatches == 1) {
                        postfix = ' ( 1 unique match)';
                    }
                    else {
                        postfix = ' (No matches)';
                    }

                }
                return ret + postfix;
            },
            finished: function() {
                return this.job.status == 3;
            },
            tableData: function() {
                var identifyData = [];
                if (this.finished) {
                    identifyData = this.job.statistics.matches;
                }
                var rows = identifyData.slice(0,50).map(function(obj) {
                    return this._getAccFromObj(obj);
                }.bind(this));
                if (this.job.statistics) {
                    this._addParent(rows,'father',false);
                    this._addParent(rows,'mother',false);
                }

                return rows;
            },
            crossesChartColumns: function() {
                return [{"type":"string","label":"Accession"},{"type":"number","label":"# Windows"},{"type":"string","role":"annotation"},{"type":"string","role":"style"}];
            },
            crossesChartRows: function() {
                var identifyData = defaultIdentifyChartRows;
                var ix = 2;
                var opacity = null;
                if (this.finished && this.job.statistics) {
                    identifyData = this.job.statistics.matches;
                    ix=1;
                    if (this.job.statistics.interpretation.case === 6) {
                        opacity = 'opacity:0.5';
                    }
                }
                var rows = identifyData.slice(0,10).map(function(obj) {
                    return [obj[0],obj[ix],null,opacity];
                }.bind(this));
                // check if parents are part of it and then sort
                if (this.job.statistics) {
                    this._addParent(rows,'father',true);
                    this._addParent(rows,'mother',true);
                }
                return rows;
            },
            crossesChartOptions: function() {
                var barColor = this.finished ? '#2196F3' : '#EEEEEE' ;
                var textColor = this.finished ? 'black': 'grey';
                var enableInteractivity = this.finished;
                return {
                    title: this.title,
                    titleTextStyle: {
                        color: textColor
                    },
                    chart: {
                        title: 'Crosses results',
                        subtitle: 'Processing...'
                    },
                    hAxis: {
                        title: 'Accession'
                    },
                    vAxis: {
                        title: '# Windows',
                        /*viewWindowMode:'explicit',
                        viewWindow:{
                            min:0.0
                        }*/
                    },
                    colors: [barColor],
                    enableInteractivity: enableInteractivity,
                    height: 350,
                    animation:{
                        duration: 1000,
                        easing: 'out',
                    },
                };
            }
        }
    });


    Vue.component('identify-result', {
        template: '#identify-result-template',
        props: ['job','accessions'],

        data: function() {
            return {
                map: false,
                markers: new L.featureGroup(),
            }
        },
        mounted: function () {
            this.$nextTick(function () {
                componentHandler.upgradeDom();
                this.map = L.map(this.$refs.map_container).setView([0.0, 0.0], 2);
                L.tileLayer.provider('Stamen.TonerLite').addTo(this.map);
                this.initMarkers(this.job);
                this.$refs.maptab.addEventListener("click", function() {
                    this.map.invalidateSize(false);
                }.bind(this));
            })
        },
        watch: {
            job: {
                handler: function(job) {
                    this.initMarkers(job);
                },
                deep:true
            },

        },
        methods: {
            initMarkers: function(job) {
                this.tableData.slice(0,10).forEach(function(acc) {
                    if (acc.latitude === null || acc.longitude === null)
                        return;
                    var icon = this.getIconFromProbability(acc.probability);
                    var popupText = acc.name+' ('+acc.id+'): '+this.roundForDisplay(acc.probability)+' %';
                    var popup = popupText+"<br><img style='width:100px;height:100px' src='"+acc.pictureUrl+"' alt='No picture available' />";
                    this.markers.addLayer(L.marker([acc.latitude, acc.longitude], {icon: icon}).bindPopup(popup,popupOptions));
                }.bind(this));
                this.markers.addTo(this.map);
                try {
                    this.map.setView(this.markers.getBounds().getCenter());
                }
                catch (e) {

                }
            },
            getIconFromProbability(probability) {
                if (probability > 0.9) {
                    return greenIcon;
                }
                else if (probability > 0.8) {
                    return orangeIcon;
                }
                else {
                    return redIcon;
                }
            },
            roundForDisplay: function(value) {
                return Math.round(value*1000)/10;
            },
            convertForHistoram: function(obj) {
                return [obj[0],obj[1]];
            },
            convertForColumn: function(obj) {
                return [obj[0],obj[1],obj[3]];
            }
        },
        computed: {
            overlapChartColumn: function() {
                return [{"type":"string","label":"Overlap"},{"type":"number","label":"%"}];
            },
            interpretation: function() {
                if (this.finished) {
                    return this.job.statistics.interpretation;
                }
                return null;
            },
            isCrossesCheck: function() {
                return this.job.crossesjob != null;
            },
            showHistogram: function() {
                if (this.finished) {
                    return this.totalNumberMatches >= this.job.dataset.numOfSamples;
                }
                return false;
            },
            overlap: function() {
                if (this.finished )  {
                    return Math.round(this.job.statistics.overlap[0]*1000)/10 + ' %';
                }
                return '...';
            },
            overlapAbs: function() {
                if (this.finished )  {
                    return this.job.statistics.overlap[1];
                }
                return null;
            },
            totalNumberMatches: function() {
                if (this.finished) {
                    return this.job.statistics.matches.length;
                }
                return '';
            },
            title: function() {
                var ret = 'Identify result';
                var postfix = ' (Processing...)';
                if (this.finished) {
                    if (this.totalNumberMatches > 10) {
                        postfix = ' (Top 10 of ' + this.totalNumberMatches + ' matches)';
                    }
                    else if( this.totalNumberMatches > 1) {
                        postfix = ' (' + this.totalNumberMatches + ' matches)';
                    }
                    else if (this.totalNumberMatches == 1) {
                        postfix = ' ( 1 unique match)';
                    }
                    else {
                        postfix = ' (No matches)';
                    }

                }
                return ret + postfix;
            },
            finished: function() {
                return this.job.status == 3;
            },
            overlapChartRows: function() {
                var rows = defualtOverlapChartRows;
                if (this.finished) {
                    var overlap = this.job.statistics.overlap[0];
                    rows = [['match',overlap],['nomatch',1-overlap]]
                }
                return rows;
            },
            overlapChartOptions: function() {
                var title = this.finished ? 'Overlap':'Processing...';
                if (this.finished) {
                    var color=null;
                    var overlap = this.job.statistics.overlap[0];
                    if (overlap > 0.8 ) {
                        color = '#4CAF50';
                    }
                    else if (overlap > 0.7) {
                        color = '#FFC107';
                    }
                    else {
                        color = '#F44336';
                    }
                    var slices = {
                        0:{color:color},
                        1:{color:'#EEEEEE'}
                    }
                }
                else {
                    var title = 'Processing...';
                    var slices = {
                        0:{color:'#EEEEEE'},
                        1:{color:'#ccc'}
                    }
                }
                return {
                    title: title,
                    pieHole:0.4,
                    legend:'none',
                    slices: slices,
                    pieSliceText:'none',
                    enableInteractivity:false,
                    theme:'maximized',
                    animation:{
                        duration: 1000,
                        easing: 'out',
                    },
                };
            },
            tableData: function() {
                var identifyData = [];
                if (this.finished) {
                    identifyData = this.job.statistics.matches;
                }
                var rows = identifyData.slice(0,50).map(function(obj) {
                    acc = this.accessions[obj[0]];
                    return {'id':obj[0],'probability':obj[1],'matches':obj[2],'overlap': obj[3]
                            ,'name':acc.name,'country':acc.country,'sitename':acc.sitename
                            ,'latitude':acc.latitude,'longitude':acc.longitude,
                            'pictureUrl':acc.pictureUrl, 'url':acc.url};
                }.bind(this));
                return rows;
            },
            identifyHistogramRows: function() {
                var rows = null;
                if (this.finished) {
                    identifyData = this.job.statistics.matches;
                    var rows = identifyData.map(this.convertForHistoram);
                }
                return rows;
            },
            identifyColumnChartRows: function() {
                var identifyData = defaultIdentifyChartRows;
                if (this.finished) {
                    identifyData = this.job.statistics.matches;
                }
                var rows = identifyData.slice(0,10).map(this.convertForColumn);
                return rows;
            },
            identifyHistogramColumns: function() {
                return [{"type":"string","label":"Accession"},{"type":"number","label":"Probablity"}];
            },
            identifyHistogramOptions: function() {
                var title = 'Histogram';
                if (this.finished) {
                    title = title+ ' of ' + this.totalNumberMatches+ ' matches';
                }
                return {
                    title:title,
                    colors: ['#2196F3'],
                    bar: { gap: 0 },
                    height: 350,
                    animation:{
                        duration: 1000,
                        easing: 'out',
                    },
                }
            },
            identifyColumnChartColumns: function() {
                return [{"type":"string","label":"Accession"},{"type":"number","label":"Probablity"},{"type":"number","label":"Overlap"}];
            },
            identifyColumnChartOptions: function() {
                var barColor = this.finished ? '#2196F3' : '#EEEEEE' ;
                var barColor2 = this.finished ? '#4CAF50': '#EEEEEE';
                var textColor = this.finished ? 'black': 'grey';
                var enableInteractivity = this.finished;
                return {
                    title: this.title,
                    titleTextStyle: {
                        color: textColor
                    },
                    chart: {
                        title: 'Identify results',
                        subtitle: 'Processing...'
                    },
                    hAxis: {
                        title: 'Accession'
                    },
                    vAxis: {
                        title: 'Probability/Overlap',
                        viewWindowMode:'explicit',
                        viewWindow:{
                            min:0.0
                        }
                    },
                    legend: {
                        //position:'none'
                    },
                    colors: [barColor,barColor2],
                    enableInteractivity: enableInteractivity,
                    height: 350,
                    animation:{
                        duration: 1000,
                        easing: 'out',
                    },
                };
            }
        }
    });

    var app = new Vue({
        el: '#app',
        data: {{ object_json | safe }},
        watch: {
            // whenever question changes, this function will run
            'progress':  function (newProgress) {
                setProgress('#genotype_progress',newProgress);
            }
         },
         mounted: function () {
            this.$nextTick(function () {
                componentHandler.upgradeDom();
            })
        },
         computed: {
            interpretationIcon:  function() {
                if (this.hasIssues) {
                    return "warning";
                }
                return "check_circle";
            },
            hasIssues: function() {
                if (this.parseFinished) {
                    return this.statistics.interpretation.case != 0;
                }
                return false;
            },
            interpretation: function() {
                if (this.parseFinished) {
                    return this.statistics.interpretation.text;
                }
                return "Processing...";
            },
            parseFinished: function() {
                return this.status == 3;
            },
            finished: function() {
                return this.identifyFinished && this.parseFinished;
            },
            numberOfSNPs: function() {
                if (!this.statistics) {
                    return 'Processing...';
                }
                return this.statistics.numOfSnps;
            },
            genotypeChartRows: function() {
                var genotypeData = defaultGenotypeChartRows;
                if (this.parseFinished) {
                    genotypeData = this.statistics.snps;
                }
                var rows = [];
                for (var key in genotypeData) {
                    rows.push([key,genotypeData[key]]);
                }
                rows.sort();
                return rows;

            },
            genotypeChartOptions: function() {
               var title = this.parseFinished ? 'Genotype statistics' : 'Genotype statistics (Processing...)'
               var barColor = this.parseFinished ? '#2196F3' : '#EEEEEE' ;
               var textColor = this.parseFinished ? 'black': 'grey';
               var enableInteractivity = this.parseFinished;
               return {
                    title: title  ,
                    titleTextStyle: {
                        color: textColor
                    },
                    chart: {
                        title: 'Genotype statistics',
                        subtitle: 'Processing...'
                    },
                    hAxis: {
                        title: 'Chromosome'
                    },
                    vAxis: {
                        title: 'Number of markers'
                    },
                    legend: { position: 'none' },
                    colors: [barColor],
                    enableInteractivity: enableInteractivity,
                    height:350,
                    animation:{
                        duration: 1000,
                        easing: 'out',
                    },
                }
            },

        }
    });

    setProgress('#genotype_progress',app.progress);

    var parseRunTime = 3600;
    var identifyRunTime = 3600;

    {% if not object.identify_finished %}
       var timerId = window.setInterval(pollBackend,3000);
    {% endif %}

    function pollBackend() {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
                if (xmlhttp.status == 200) {
                    var result = JSON.parse(xmlhttp.responseText);
                    var isChanged = false;
                    if (app.status !== result.status) {
                        isChanged = true;
                        app.statistics = result.statistics;
                    }
                    app.progress = result.progress;
                    app.remaining = result.remaining;
                    app.status = result.status;
                    app.statusText = result.statusText;
                    for (var i=0;i<result.identifyjobSet.length;i++) {
                        var identifyJob = app.identifyjobSet[i];
                        var newIdentifyJob = result.identifyjobSet[i];
                        identifyJob.progress = newIdentifyJob.progress;
                        identifyJob.remaining = newIdentifyJob.remaining;
                        if (identifyJob.status !== newIdentifyJob.status) {
                            isChanged = true;
                            app.$set(app.identifyjobSet,i,newIdentifyJob);
                        }
                        else if (newIdentifyJob.crossesjob && (!identifyJob.crossesjob || newIdentifyJob.crossesjob.status !== identifyJob.crossesjob.status)) {
                            identifyJob.crossesjob = newIdentifyJob.crossesjob;
                            isChanged = true;
                        }
                        else if (newIdentifyJob.crossesjob  && newIdentifyJob.crossesjob) {
                             identifyJob.crossesjob.progress = newIdentifyJob.crossesjob.progress;
                             identifyJob.crossesjob.remaining = newIdentifyJob.crossesjob.remaining;
                        }
                    }
                    if (isChanged) {
                        isChanged = false;
                        app.accessions = result.accessions;
                    }
                    app.identifyFinished = result.identifyFinished;

                    if (app.finished) {
                        window.clearInterval(timerId)
                    }
                }
                else {
                    window.clearInterval(timerId)
                }
            }
        };
        xmlhttp.open("GET", "{% url 'genotypesubmission-detail' object.id %}", true);
        xmlhttp.setRequestHeader('Accept','application/json')
        xmlhttp.send();
    }


    function updateProgressBar() {

    }
    {% endautoescape %}

</script>
{% endblock content %}
